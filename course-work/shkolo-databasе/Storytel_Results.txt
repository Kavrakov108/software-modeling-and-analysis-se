Резултати от създадените функции, приложени върху данните от база данни StorytelDB
               Функция BOOK_AVERAGE_RATING

Извежда средната оценка за дадена книга.

CREATE FUNCTION BOOK_AVERAGE_RATING(@BOOK_ID INT)
RETURNS VARCHAR(200)
AS
BEGIN
    DECLARE @TITLE NVARCHAR(200), @AVG_RATING NUMERIC(3,2)

    SELECT @TITLE = Title, 
           @AVG_RATING = AVG(Rating)
    FROM Books B 
    JOIN Reviews R ON B.BookId = R.BookId
    WHERE B.BookId = @BOOK_ID
    GROUP BY B.BookId, Title

    RETURN @TITLE + ' (ID = ' + CAST(@BOOK_ID AS VARCHAR) + '), средна оценка: ' 
           + CAST(@AVG_RATING AS VARCHAR) + '.'
END


Примерна заявка:

SELECT dbo.BOOK_AVERAGE_RATING(BookId) AS RESULT
FROM Books;

                      Функция AUTHOR_BOOK_COUNT

Извежда броя на книгите на даден автор.

CREATE FUNCTION AUTHOR_BOOK_COUNT(@AUTHOR_ID INT)
RETURNS VARCHAR(200)
AS
BEGIN
    DECLARE @NAME NVARCHAR(200), @COUNT INT

    SELECT @NAME = FullName,
           @COUNT = COUNT(BookId)
    FROM Authors A
    JOIN BookAuthors BA ON A.AuthorId = BA.AuthorId
    WHERE A.AuthorId = @AUTHOR_ID
    GROUP BY FullName

    RETURN @NAME + ' (ID = ' + CAST(@AUTHOR_ID AS VARCHAR) + '), брой книги: ' 
           + CAST(@COUNT AS VARCHAR) + '.'
END


Примерна заявка:

SELECT dbo.AUTHOR_BOOK_COUNT(AuthorId) AS RESULT
FROM Authors;

           Функция GENRE_BOOK_COUNT

Извежда броя на книгите за даден жанр.

CREATE FUNCTION GENRE_BOOK_COUNT(@GENRE_ID INT)
RETURNS VARCHAR(200)
AS
BEGIN
    DECLARE @NAME NVARCHAR(100), @COUNT INT

    SELECT @NAME = Name,
           @COUNT = COUNT(BookId)
    FROM Genres G
    JOIN BookGenres BG ON G.GenreId = BG.GenreId
    WHERE G.GenreId = @GENRE_ID
    GROUP BY Name

    RETURN @NAME + ' (ID = ' + CAST(@GENRE_ID AS VARCHAR) 
           + '), брой книги: ' + CAST(@COUNT AS VARCHAR) + '.'
END


Примерна заявка:

SELECT dbo.GENRE_BOOK_COUNT(GenreId) AS RESULT
FROM Genres;

2. Резултати от създадените съхранени процедури в StorytelDB
     Съхранена процедура BOOK_STATS

Връща средна оценка и брой ревюта за дадена книга.

CREATE PROCEDURE BOOK_STATS 
    @BOOK_ID INT,
    @REVIEW_COUNT INT OUTPUT,
    @AVG_RATING NUMERIC(3,2) OUTPUT
AS
BEGIN
    SELECT @REVIEW_COUNT = COUNT(ReviewId)
    FROM Reviews
    WHERE BookId = @BOOK_ID

    SELECT @AVG_RATING = AVG(Rating)
    FROM Reviews
    WHERE BookId = @BOOK_ID
END


Примерно изпълнение:

DECLARE @count INT, @avg NUMERIC(3,2)
EXEC BOOK_STATS 1, @count OUTPUT, @avg OUTPUT
PRINT 'Брой ревюта: ' + CAST(@count AS VARCHAR)
PRINT 'Средна оценка: ' + CAST(@avg AS VARCHAR)

      Съхранена процедура USER_SUBSCRIPTION_INFO

Извежда информация за активния абонамент на потребител.

CREATE PROCEDURE USER_SUBSCRIPTION_INFO
    @USER_ID INT
AS
BEGIN
    SELECT U.Email, SP.PlanName, US.StartDate, US.EndDate, US.IsActive
    FROM Users U
    JOIN UserSubscriptions US ON U.UserId = US.UserId
    JOIN SubscriptionPlans SP ON SP.PlanId = US.PlanId
    WHERE U.UserId = @USER_ID AND US.IsActive = 1
END


Примерна заявка:

EXEC USER_SUBSCRIPTION_INFO 1

     Съхранена процедура PAYMENTS_SUMMARY

Връща общата сума платена от потребител.

CREATE PROCEDURE PAYMENTS_SUMMARY
    @USER_ID INT
AS
BEGIN
    SELECT U.Email, SUM(Amount) AS TotalPaid
    FROM Payments P
    JOIN Users U ON U.UserId = P.UserId
    WHERE P.UserId = @USER_ID
    GROUP BY U.Email
END


Примерна заявка:

EXEC PAYMENTS_SUMMARY 1

3. Резултати от създадените тригери в StorytelDB
   Таблица REVIEW_HISTORY
CREATE TABLE REVIEW_HISTORY
(
    ChangeId INT IDENTITY PRIMARY KEY,
    ReviewId INT NOT NULL,
    UserId INT NOT NULL,
    BookId INT NOT NULL,
    Rating INT NOT NULL,
    Title NVARCHAR(200),
    Comment NVARCHAR(MAX),
    ChangeDate DATETIME NOT NULL,
    Operation CHAR(3) NOT NULL CHECK (Operation IN ('INS','DEL'))
)

   Тригер TRG_REVIEW_HISTORY

Записва история при добавяне или изтриване на ревю.

CREATE TRIGGER TRG_REVIEW_HISTORY
ON Reviews
AFTER INSERT, DELETE
AS
BEGIN
    SET NOCOUNT ON;

    -- INSERT операции
    INSERT INTO REVIEW_HISTORY
    (ReviewId, UserId, BookId, Rating, Title, Comment, ChangeDate, Operation)
    SELECT ReviewId, UserId, BookId, Rating, Title, Comment, GETDATE(), 'INS'
    FROM inserted

    -- DELETE операции
    INSERT INTO REVIEW_HISTORY
    (ReviewId, UserId, BookId, Rating, Title, Comment, ChangeDate, Operation)
    SELECT ReviewId, UserId, BookId, Rating, Title, Comment, GETDATE(), 'DEL'
    FROM deleted
END

Примерни заявки
Добавяне на ревю:
INSERT INTO Reviews (UserId, BookId, Rating, Title, Comment)
VALUES (1, 1, 5, 'Супер книга', 'Страхотно изживяване')

Проверка на историята:
SELECT * FROM REVIEW_HISTORY